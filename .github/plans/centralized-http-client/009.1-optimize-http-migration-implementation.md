# 實作指南：中央化 HTTP 客戶端遷移 - 移除 Factory 與 Monitor 設計

## 檔案修改清單

### 核心檔案修改

#### 1. `scripts/civitai_manager_libs/http_client.py`

**重大重構**：
- 移除 `CivitaiHttpClient` 類別定義
- 將 `OptimizedHTTPClient` 重新命名為 `CivitaiHttpClient`
- 移除 `MemoryEfficientDownloader` 類別
- 移除 `IntelligentCache` 類別
- 簡化 `ChunkedDownloader`
- 新增全域工廠函數

**新結構示例**：
```python
"""
Unified HTTP client module for Civitai integration.
Provides optimized HTTP client with connection pooling, retries, and chunked downloads.
"""

import requests
from urllib3.util.retry import Retry
from requests.adapters import HTTPAdapter
from typing import Optional, Dict, Callable, List
import time
import threading
import random
import os

from . import util, setting

# HTTP status code messages for user-friendly error reporting
_STATUS_CODE_MESSAGES = {
    400: "Bad Request: Invalid request parameters.",
    401: "Unauthorized: Invalid or missing API key.",
    403: "Forbidden: Access denied.",
    404: "Not Found: The requested resource does not exist.",
    429: "Rate Limited: Too many requests. Please try again later.",
    500: "Internal Server Error: Server encountered an error.",
    502: "Bad Gateway: Server received invalid response.",
    503: "Service Unavailable: Server is temporarily unavailable.",
    504: "Gateway Timeout: Server did not respond in time.",
    524: "Cloudflare Timeout: The request timed out.",
}

# Global HTTP client instance
_global_http_client = None
_client_lock = threading.Lock()


class CivitaiHttpClient:
    """
    Optimized HTTP client with connection pooling, retries, and robust error handling.
    Formerly known as OptimizedHTTPClient, now unified as the primary HTTP client.
    """

    def __init__(self, api_key: str = None, timeout: int = None, max_retries: int = None, 
                 retry_delay: float = None):
        # 合併原始功能
        self.api_key = api_key or setting.civitai_api_key
        self.timeout = timeout or setting.http_timeout
        self.max_retries = max_retries or setting.http_max_retries
        self.retry_delay = retry_delay or setting.http_retry_delay

        # Connection pool settings
        self.pool_connections = setting.http_pool_connections
        self.pool_maxsize = setting.http_pool_maxsize
        self.pool_block = setting.http_pool_block

        # 簡化統計（移除複雜監控）
        self._stats = {
            'total_requests': 0,
            'successful_requests': 0,
            'failed_requests': 0,
        }
        self._stats_lock = threading.Lock()

        # 初始化優化的 session
        self._setup_optimized_session()

    def _setup_optimized_session(self):
        """Set up requests session with optimized settings and retry strategy."""
        # 保留原優化邏輯
        pass

    # 保留所有原 OptimizedHTTPClient 的核心方法
    # 移除監控統計的複雜邏輯，僅保留基本計數
    
    def get_json(self, url: str, params: Dict = None) -> Optional[Dict]:
        """Make GET request and return JSON response or None on error."""
        pass
    
    def post_json(self, url: str, json_data: Dict = None) -> Optional[Dict]:
        """Make POST request with JSON payload and return JSON response or None on error."""
        pass
    
    def get_stream(self, url: str, headers: Dict = None) -> Optional[requests.Response]:
        """Get streaming response for large file downloads."""
        pass
    
    def download_file(self, url: str, filepath: str, progress_callback: Optional[Callable] = None) -> bool:
        """Download file with progress callback support."""
        pass


class ChunkedDownloader:
    """Downloader supporting chunked and parallel file downloads."""

    def __init__(self, client: CivitaiHttpClient):
        self.client = client
        self.chunk_size = setting.http_chunk_size
        self.max_parallel = setting.http_max_parallel_chunks

    def download_large_file(self, url: str, filepath: str, 
                           progress_callback: Optional[Callable] = None) -> bool:
        """Download large file with optional parallel chunks."""
        # 保留原功能，移除監控邏輯
        pass

    def _fallback_download(self, url: str, filepath: str, 
                          progress_callback: Optional[Callable] = None) -> bool:
        """Fallback to standard download when chunked download is not applicable."""
        return self.client.download_file(url, filepath, progress_callback)

    def _sequential_download(self, url: str, filepath: str, total_size: int, 
                           progress_callback: Optional[Callable] = None) -> bool:
        """Download file sequentially in a single stream."""
        # 保留原實作
        pass

    def _parallel_download(self, url: str, filepath: str, total_size: int, 
                         progress_callback: Optional[Callable] = None) -> bool:
        """Download file using parallel chunked requests."""
        # 保留原實作
        pass


# Global factory functions
def get_http_client() -> CivitaiHttpClient:
    """Get or create the global HTTP client instance."""
    global _global_http_client
    if _global_http_client is None:
        with _client_lock:
            if _global_http_client is None:
                _global_http_client = CivitaiHttpClient(
                    api_key=setting.civitai_api_key,
                    timeout=setting.http_timeout,
                    max_retries=setting.http_max_retries,
                    retry_delay=setting.http_retry_delay,
                )
    else:
        # 動態更新 API key
        if _global_http_client.api_key != setting.civitai_api_key:
            _global_http_client.update_api_key(setting.civitai_api_key)
    return _global_http_client


def get_chunked_downloader() -> ChunkedDownloader:
    """Get chunked downloader instance using the global HTTP client."""
    return ChunkedDownloader(get_http_client())
```

#### 2. `scripts/civitai_manager_libs/civitai.py`

**變更清單**：
- 移除模組級 `_http_client` 變數
- 移除 `get_http_client()` 函數
- 更新匯入語句
- 更新所有使用客戶端的函數

**修改示例**：
```python
# 舊程式碼
import os
import json
from . import util
from . import setting

from .http_client import CivitaiHttpClient

_http_client = None

def get_http_client():
    global _http_client
    if _http_client is None:
        _http_client = CivitaiHttpClient(...)
    return _http_client

# 新程式碼
import os
import json
from . import util
from . import setting
from .http_client import get_http_client

# 移除模組級變數和函數

def request_models(nsfw: str = "true", sort: str = "Highest Rated", limit: int = 20, 
                  page: int = 1, query: str = "", tag: str = "", types: list = None):
    client = get_http_client()
    # 使用統一客戶端
    return client.get_json(url, params=params) or {"items": [], "metadata": {}}
```

#### 3. `scripts/civitai_manager_libs/downloader.py`

**變更清單**：
- 移除 `_download_client` 變數
- 移除 `get_download_client()` 函數
- 更新匯入語句
- 使用統一的客戶端和分段下載器

**修改示例**：
```python
# 舊程式碼
from .http_client import CivitaiHttpClient

_download_client = None

def get_download_client() -> CivitaiHttpClient:
    global _download_client
    if _download_client is None:
        _download_client = CivitaiHttpClient(...)
    return _download_client

# 新程式碼
from .http_client import get_http_client, get_chunked_downloader

def download_file(url: str, file_path: str) -> bool:
    """Download large files using chunked downloader."""
    downloader = get_chunked_downloader()
    return downloader.download_large_file(url, file_path)

def download_file_gr(url: str, file_path: str, progress_gr=None) -> bool:
    """Download files with Gradio progress integration."""
    def progress_wrapper(downloaded, total):
        if progress_gr and hasattr(progress_gr, 'progress'):
            progress = downloaded / total if total > 0 else 0
            progress_gr.progress = progress
    
    downloader = get_chunked_downloader()
    return downloader.download_large_file(url, file_path, progress_callback=progress_wrapper)
```

#### 4. `scripts/civitai_manager_libs/ishortcut.py`

**變更清單**：
- 移除 `_shortcut_client` 變數
- 移除 `get_shortcut_client()` 函數
- 更新所有使用客戶端的地方

#### 5. `scripts/civitai_manager_libs/util.py`

**變更清單**：
- 移除直接實例化 `CivitaiHttpClient` 的程式碼
- 使用統一的 `get_http_client()`

**修改示例**：
```python
# 舊程式碼
def download_image_safe(url: str, save_path: str, client=None, show_error: bool = True) -> bool:
    if client is None:
        from .http_client import CivitaiHttpClient
        client = CivitaiHttpClient()

# 新程式碼
def download_image_safe(url: str, save_path: str, client=None, show_error: bool = True) -> bool:
    if client is None:
        from .http_client import get_http_client
        client = get_http_client()
```

### 要刪除的檔案

1. `scripts/civitai_manager_libs/monitoring.py`
2. `tests/monitoring/test_monitoring.py`
3. `tests/performance/test_http_performance.py`

### 設定檔更新

#### `scripts/civitai_manager_libs/setting.py`

**移除的設定**：
- `http_memory_monitor_enabled`
- `http_max_memory_usage_mb`
- `http_memory_check_interval`
- 其他監控相關設定

**保留的設定**：
- `http_timeout`
- `http_max_retries`
- `http_retry_delay`
- `http_pool_connections`
- `http_pool_maxsize`
- `http_pool_block`
- `http_chunk_size`
- `http_max_parallel_chunks`

### 測試檔案更新

#### 1. `tests/test_http_client.py`

**變更重點**：
- 更新測試以使用新的 `CivitaiHttpClient`
- 移除 `OptimizedHTTPClient` 測試
- 新增全域工廠函數測試
- 新增 `ChunkedDownloader` 測試

#### 2. `tests/test_civitai.py`

**變更重點**：
- 移除 `get_http_client` 測試（因為函數已移除）
- 更新 Mock 設定以使用全域客戶端

#### 3. `tests/test_downloader.py`

**變更重點**：
- 移除 `get_download_client` 測試
- 更新測試以使用新的下載函數

## 實作步驟

### 步驟 1：備份與準備

```bash
# 建立實作分支
git checkout -b optimize-http-migration

# 備份關鍵檔案
cp scripts/civitai_manager_libs/http_client.py scripts/civitai_manager_libs/http_client.py.bak
cp scripts/civitai_manager_libs/monitoring.py scripts/civitai_manager_libs/monitoring.py.bak
```

### 步驟 2：重構核心 HTTP 客戶端

1. 修改 `scripts/civitai_manager_libs/http_client.py`
2. 運行基本測試確認核心功能

```bash
pytest tests/test_http_client.py -v
```

### 步驟 3：更新使用模組

按順序更新：
1. `civitai.py`
2. `downloader.py`
3. `ishortcut.py`
4. `util.py`
5. 其他模組

每個模組更新後都運行相關測試。

### 步驟 4：刪除監控模組

```bash
rm scripts/civitai_manager_libs/monitoring.py
rm tests/monitoring/test_monitoring.py
rm tests/performance/test_http_performance.py
```

### 步驟 5：更新設定和測試

1. 更新 `setting.py`
2. 更新所有測試檔案
3. 運行完整測試套件

### 步驟 6：程式碼品質檢查

```bash
# 格式化程式碼
black --line-length=100 --skip-string-normalization scripts/civitai_manager_libs/http_client.py
black --line-length=100 --skip-string-normalization scripts/civitai_manager_libs/civitai.py
black --line-length=100 --skip-string-normalization scripts/civitai_manager_libs/downloader.py
black --line-length=100 --skip-string-normalization scripts/civitai_manager_libs/ishortcut.py
black --line-length=100 --skip-string-normalization scripts/civitai_manager_libs/util.py

# 檢查程式碼品質
flake8 scripts/civitai_manager_libs/http_client.py
flake8 scripts/civitai_manager_libs/civitai.py
flake8 scripts/civitai_manager_libs/downloader.py
flake8 scripts/civitai_manager_libs/ishortcut.py
flake8 scripts/civitai_manager_libs/util.py

# 運行完整測試
pytest --disable-warnings --maxfail=5
```

## 驗證檢查清單

### 功能驗證

- [ ] 所有 HTTP 請求正常工作
- [ ] 檔案下載功能正常
- [ ] 分段下載功能正常
- [ ] 進度回調功能正常
- [ ] API key 動態更新正常
- [ ] 錯誤處理正常

### 程式碼品質

- [ ] 所有檔案通過 `black` 格式化
- [ ] 所有檔案通過 `flake8` 檢查
- [ ] 所有單元測試通過
- [ ] 所有整合測試通過
- [ ] 測試覆蓋率維持在合理水準

### 架構驗證

- [ ] 只有一個 HTTP 客戶端類別
- [ ] 只有一個全域工廠函數
- [ ] 沒有多餘的監控程式碼
- [ ] 沒有未使用的類別和函數
- [ ] 分段下載器正常工作

## 預期效果

完成此遷移後，系統將具備：

1. **統一的 HTTP 客戶端**：所有模組使用相同的優化客戶端
2. **簡化的架構**：移除不必要的抽象層和複雜設計
3. **保留的核心功能**：連線池、智慧重試、分段下載
4. **更好的維護性**：更少的程式碼，更清楚的結構
5. **相同的效能**：使用原 `OptimizedHTTPClient` 的所有優化功能

這個遷移將徹底簡化 centralized HTTP client 的設計，符合 KISS 和 DRY 原則，為專案的長期發展提供更穩固的基礎。
